"use strict";
var baseDriver = require('driver');
var pg = require('pg');
var names = {};
var uniquifier = 0;

module.exports = function (options) {
  var driver = baseDriver({
    run : function(sql, params, rowCallback, endCallback, errorCallback) {
      pg.connect(options, function(err, client) {
        var name;
        if (err) {
          errorCallback(err);
        } else {
          if (names[sql] !== undefined) {
            name = names[sql];
          } else {
            name = 'query' + uniquifier++;
            names[sql] = name;
          }
          var q = client.query({
            name : name,
            text : sql,
            values : params
          });
          q.on('row', rowCallback);
          q.on('end', endCallback);
        }
      });
    },
    getBind : function(params) {
      if (params.bind === undefined) params.bind = 1;
      return '$' + params.bind++;
    },
  });
  return driver;
};