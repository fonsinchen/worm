"use strict";

var transformation = require('transformation');
var parser = require('sqlexpr');
var expression = require('expression');
var bind = require('bind');
var render = require('render');

module.exports = function(descriptor) {
    return {
        bind : function(model, tableDesc) {
            var bound = bind(descriptor, model, tableDesc);
            var where = undefined;
            var limit = undefined;
            var offset = undefined;
            return {
                where : function(expr) {
                    where = [parser.parse(expr)];
                    return this;
                },
                and : function(expr) {
                    where.push('AND', parser.parse(expr));
                    return this;
                },
                or : function(expr) {
                    where.push('OR', parser.parse(expr));
                    return this;
                },
                limit : function(num) {
                    limit = num;
                    return this;
                },
                offset : function(num) {
                    offset = num;
                    return this;
                },
                render : function(driver) {
                    return render(driver, bound, expression.inject(where), limit, offset);
                }
            }
        }
        
    };
};
