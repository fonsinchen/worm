"use strict";

var transformation = require('transformation');
var sqlexpr = require('sqlexpr');
var bind = require('bind');
var render = rquire('render');

module.exports = function(descriptor) {
    transformation.prepare(descriptor);
    return {
        bind : function(model, tableDesc) {
            var bound = bind(descriptor, model, tableDesc);
            var where = null;
            var limit = null;
            var offset = null;
            return {
                where : function(expr) {
                    where = [sqlexpr.parse(expr)];
                    return this;
                },
                and : function(expr) {
                    where.push('AND', sqlexpr.parse(expr));
                    return this;
                },
                or : function(expr) {
                    where.push('OR', sqlexpr.parse(expr));
                    return this;
                },
                limit : function(num) {
                    limit = num;
                    return this;
                },
                offset : function(num) {
                    offset = num;
                    return this;
                },
                render : function(driver) {
                    return render(driver, bound, where, limit, offset);
                }
            }
        }
        
    };
};