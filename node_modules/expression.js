"use strict";

var parser = require('sqlexpr');

var render = function(item, driver, params) {
    if (item instanceof Array) {
        return item.map(function(item) {
            return render(item, driver, params);
        }).join(' ');
    } else if (typeof item === 'string') {
        return item;
    } else if (item.literal !== undefined) {
        switch (typeof item.literal) {
            case "number": return item.literal;
            case "string": return driver.quoteString(item.literal);
            default: throw "Unknown SQL construct " + item;
        }
    } else if (item.column !== undefined) {
        var column = '';
        if (item.schema !== undefined) column += driver.quoteIdentifier(item.schema) + '.';
        if (item.table !== undefined) column += driver.quoteIdentifier(item.table) + '.';
        return column + driver.quoteIdentifier(item.column);
    } else if (item.braced !== undefined) {
        return '(' + render(item.braced, driver, params) + ')';
    } else if (item.bind !== undefined) {
        return driver.getBind(params);
    } else {
        throw "Unknown SQL construct " + item;
    }
}

module.exports = function(expression) {
    return module.exports.inject(parser.parse(expression));
};

module.exports.inject = function(syntax_tree) {
    return {
        render : function(driver, params) {
            return render(syntax_tree, driver, params);
        },
        eval : function(params) {}
    }
}