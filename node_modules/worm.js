"use strict";

var expression = require('expression');
var descriptor = require('descriptor');

if (typeof Object.create !== 'function') {
    Object.create = function (obj) {
        var F = function() {};
        F.prototype = obj;
        return new F();
    };
}

Object.prototype.forEach = function(callback) {
    var k, owns = Object.prototype.hasOwnProperty;
    for (k in this) {
        if (owns.call(this, k)) callback(k, this[k]);
    }
};


var worm = function(driver, structure) {
    return function(table, d) {
        var desc = descriptor(table, structure, d);
        var where = null;
        var whereParams = null;
        return {
            where : function(exprString, params) {
                where = expression(exprString);
                whereParams = params;
                return this;
            },
            limit : function() {return this;},
            order : function() {return this;},
            select : function(callback) {
                var sql = 'SELECT ' + desc.renderSelect(driver) +
                          ' FROM ' + desc.renderFrom(driver) + 
                          (where !== null ? ' WHERE ' + where.render(driver) : ''); // + limit + order
                var extract = desc.extract(driver, callback);
                driver.run(sql, whereParams, extract.row , extract.end, function(err) {
                    callback(err);
                });
            },
            insert : function(values, callback) {},
            update : function(values, callback) {},
            "delete" : function(callback) {}
        }
    }
}

module.exports = function (driverName, options, callback) {
    if (arguments.length < 3) {
        callback = options;
        options = {};
    }

    try {
        var driver = require(require('path').join(__dirname, 'drivers', driverName))(options);
        callback(null, worm(driver, options.structure));
    } catch (e) {
        callback(e);
    }
};

